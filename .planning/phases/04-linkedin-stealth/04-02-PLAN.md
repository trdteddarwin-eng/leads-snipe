---
phase: 04-linkedin-stealth
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - execution/linkedin_stealth.py
  - execution/test_linkedin_stealth.py
autonomous: true

must_haves:
  truths:
    - "Single find_linkedin() function returns LinkedInResult for any name/company"
    - "System falls back to Bing when DDG fails or rate-limits"
    - "Batch processing respects concurrency limits"
    - "CLI works for manual testing"
    - "Unit tests validate all search and parsing logic"
  artifacts:
    - path: "execution/linkedin_stealth.py"
      provides: "Public API with multi-strategy orchestration"
      exports: ["find_linkedin", "find_linkedin_batch", "find_linkedin_sync"]
      min_lines: 250
    - path: "execution/test_linkedin_stealth.py"
      provides: "Unit tests for LinkedIn stealth search"
      contains: "test_search_duckduckgo"
      min_lines: 100
  key_links:
    - from: "find_linkedin"
      to: "search_duckduckgo"
      via: "primary search call"
      pattern: "await search_duckduckgo"
    - from: "find_linkedin"
      to: "search_bing"
      via: "fallback on DDG failure"
      pattern: "await search_bing"
    - from: "find_linkedin_batch"
      to: "asyncio.Semaphore"
      via: "concurrency control"
      pattern: "Semaphore\\(max_concurrent\\)"
---

<objective>
Create unified public API that orchestrates DDG/Bing strategies and add comprehensive unit tests.

Purpose: Provide single entry point for LinkedIn discovery with automatic fallback and batch support
Output: Enhanced `execution/linkedin_stealth.py` with public API + `execution/test_linkedin_stealth.py`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-linkedin-stealth/04-01-SUMMARY.md
@execution/linkedin_stealth.py (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 4.4: Public API & Multi-Strategy Orchestration</name>
  <files>execution/linkedin_stealth.py</files>
  <action>
Add unified public API that orchestrates DDG -> Bing fallback:

1. Implement async find_linkedin(name: str, company: str, location: str = "") -> LinkedInResult:
   - Try DDG first via search_duckduckgo()
   - On DDG success: parse snippet, return LinkedInResult with source="duckduckgo"
   - On DDG failure/rate-limit: try Bing via search_bing()
   - On Bing success: parse snippet, return LinkedInResult with source="bing"
   - On both fail: return LinkedInResult with all fields None
   - Set confidence="low" for all snippet-extracted data

2. Implement async find_linkedin_batch(leads: list[dict], max_concurrent: int = 5, progress_callback: Optional[Callable] = None) -> list[dict]:
   - Use asyncio.Semaphore for concurrency control (max 5 - conservative)
   - Process leads in parallel within semaphore limit
   - Call progress_callback(completed, total) after each lead
   - Return list of dicts with original lead data + linkedin_url, owner_name, owner_title, source

3. Implement find_linkedin_sync(name: str, company: str) -> LinkedInResult:
   - Sync wrapper using asyncio.run() for non-async callers

4. Add CLI interface at bottom:
   if __name__ == "__main__":
       Usage: python linkedin_stealth.py "John Smith" "Acme Corp"
       Parse args, call find_linkedin_sync, print result

Never make direct requests to linkedin.com in any code path.
  </action>
  <verify>python -c "from execution.linkedin_stealth import find_linkedin, find_linkedin_batch, find_linkedin_sync; import asyncio; result = find_linkedin_sync('Test Name', 'Test Company'); print(f'Result type: {type(result).__name__}'); assert hasattr(result, 'linkedin_url')"</verify>
  <done>find_linkedin returns LinkedInResult with DDG->Bing fallback, find_linkedin_batch processes leads with concurrency control, find_linkedin_sync provides sync wrapper, CLI works for testing.</done>
</task>

<task type="auto">
  <name>Task 4.5: Unit Tests</name>
  <files>execution/test_linkedin_stealth.py</files>
  <action>
Create comprehensive unit tests for all LinkedIn stealth functionality:

1. DDG search tests:
   - test_search_duckduckgo_success: Mock DDGS to return valid LinkedIn result
   - test_search_duckduckgo_rate_limit: Mock 202 response, verify graceful handling
   - test_search_duckduckgo_no_results: Mock empty results, verify returns None

2. Bing search tests:
   - test_search_bing_success: Mock httpx to return HTML with LinkedIn result
   - test_search_bing_blocked: Mock 403 response, verify returns None
   - test_search_bing_captcha: Mock CAPTCHA page, verify returns None

3. URL extraction tests:
   - test_extract_linkedin_url_valid: Extract from https://linkedin.com/in/john-smith/
   - test_extract_linkedin_url_country_code: Extract from https://uk.linkedin.com/in/john-smith/
   - test_filter_invalid_urls: Verify /company/, /jobs/, /share/ filtered out

4. Snippet parsing tests:
   - test_parse_snippet_standard: "John Smith - CEO | LinkedIn" -> name, title
   - test_parse_snippet_minimal: "John Smith | LinkedIn" -> name only
   - test_parse_snippet_with_company: "John Smith - CEO at Acme | LinkedIn"
   - test_parse_snippet_edge_cases: Handle Dr., Jr., commas in title
   - test_parse_snippet_malformed: Return None on garbage input, no exception

5. Integration tests:
   - test_find_linkedin_ddg_success: DDG returns result, Bing not called
   - test_find_linkedin_ddg_fail_bing_success: DDG fails, Bing returns result
   - test_find_linkedin_both_fail: Both fail, return empty LinkedInResult
   - test_batch_concurrency: Verify semaphore limits concurrent calls
   - test_no_direct_linkedin_requests: Mock httpx, verify no linkedin.com calls

Use pytest and pytest-asyncio. Mock DDGS class and httpx.AsyncClient.
  </action>
  <verify>cd /Users/yoljean/Downloads/drive-download-20260102T175259Z-3-001 && python -m pytest execution/test_linkedin_stealth.py -v --tb=short 2>&1 | head -50</verify>
  <done>All 11+ test cases pass, covering DDG search, Bing fallback, URL extraction, snippet parsing, multi-strategy orchestration, and batch processing.</done>
</task>

</tasks>

<verification>
Run full test suite and verify CLI:

```bash
# Run all tests
python -m pytest execution/test_linkedin_stealth.py -v

# Test CLI
python execution/linkedin_stealth.py "John Smith" "Acme Corp"
```

Expected: All tests pass, CLI outputs LinkedInResult (may have None fields if no real match).
</verification>

<success_criteria>
1. find_linkedin() returns LinkedInResult with automatic DDG->Bing fallback
2. find_linkedin_batch() processes multiple leads with max 5 concurrent
3. find_linkedin_sync() provides sync wrapper for non-async code
4. CLI accepts "name" "company" args and prints result
5. All unit tests pass (pytest exit code 0)
6. No code path makes direct requests to linkedin.com
</success_criteria>

<output>
After completion, create `.planning/phases/04-linkedin-stealth/04-02-SUMMARY.md`
</output>
